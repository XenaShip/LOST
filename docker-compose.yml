services:
  db:
    image: postgres:16-alpine
    env_file:
      - .env
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      TZ: Europe/Moscow
    volumes:
      - pg_data:/var/lib/postgresql/data
      - /etc/localtime:/etc/localtime:ro
    ports:
      - "5432:5432"
    networks: [app_network]
    restart: unless-stopped

  # --- БОТ 1: парсер каналов (bot.py) ---
  bot1:
    build:
      context: .
      dockerfile: Dockerfile.bot_cian   # можно один Dockerfile на всех; лишний Chromium не мешает
    env_file:
      - .env
    environment:
      TZ: Europe/Moscow
      IN_DOCKER: "1"
    command: ["python", "bot.py"]
    depends_on:
      - db
    networks: [app_network]
    restart: unless-stopped

  # --- БОТ 2: подписки/рассылки (bot_3_2.py) ---
  bot2:
    build:
      context: .
      dockerfile: Dockerfile.bot_cian
    env_file:
      - .env
    environment:
      TZ: Europe/Moscow
      IN_DOCKER: "1"
    command: ["python", "bot_3_2.py"]   # если у тебя другое имя файла — замени здесь
    depends_on:
      - db
    networks: [app_network]
    restart: unless-stopped

  # --- БОТ 3: CIAN (bot_cian.py) ---
  bot_cian:
    build:
      context: .
      dockerfile: Dockerfile.bot_cian
    env_file:
      - .env
    environment:
      TZ: Europe/Moscow
      IN_DOCKER: "1"
      UC_VERSION_MAIN: "141"  # мажорная версия Chrome/ChromeDriver на сервере
      # безопасные флаги для headless Chrome в контейнере
      CHROME_EXTRA_ARGS: "--no-sandbox --disable-dev-shm-usage --disable-gpu --disable-software-rasterizer --window-size=1920,1080 --disable-blink-features=AutomationControlled --headless=new"
    # большой /dev/shm уменьшает падения браузера
    volumes:
      - /dev/shm:/dev/shm
      - /etc/localtime:/etc/localtime:ro
    command: ["python", "bot_cian.py"]
    depends_on:
      - db
    networks: [app_network]
    restart: unless-stopped

networks:
  app_network:
    driver: bridge

volumes:
  pg_data:
